<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOEIC Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --success: #10b981;
            --success-light: #ecfdf5;
            --danger: #ef4444;
            --danger-light: #fef2f2;
            --warning: #f59e0b;
            --warning-light: #fffbeb;
            --info: #0891b2;
            --info-light: #cffafe;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, .07), 0 2px 4px -2px rgba(0, 0, 0, .05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, .1), 0 8px 10px -6px rgba(0, 0, 0, .05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            padding: 24px;
            line-height: 1.5;
            transition: direction .2s;
        }

        /* ── HEADER ── */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            padding: 16px 28px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 28px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand-logo {
            height: 48px;
            width: auto;
            object-fit: contain;
        }

        .brand-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .brand-text h1 {
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
        }

        .brand-text small {
            font-size: .68rem;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: .06em;
            text-transform: uppercase;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* ── BUTTONS ── */
        .btn {
            padding: 9px 18px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 700;
            border: 1px solid transparent;
            font-size: .82rem;
            font-family: 'Cairo', 'Inter', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 7px;
            white-space: nowrap;
            transition: background .15s, border-color .15s, color .15s, opacity .15s;
        }

        .btn:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-outline {
            background: white;
            color: var(--text-main);
            border-color: var(--border);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success-light);
            color: var(--success);
            border-color: #a7f3d0;
        }

        .btn-success:hover:not(:disabled) {
            background: #d1fae5;
        }

        .btn-danger {
            background: var(--danger-light);
            color: var(--danger);
            border-color: #fecaca;
        }

        .btn-danger:hover:not(:disabled) {
            background: #fee2e2;
        }

        .btn-warning {
            background: var(--warning-light);
            color: var(--warning);
            border-color: #fde68a;
        }

        .btn-warning:hover:not(:disabled) {
            background: #fef3c7;
        }

        /* ── LANG TOGGLE ── */
        .lang-toggle {
            display: flex;
            align-items: center;
            gap: 0;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            flex-shrink: 0;
        }

        .lang-btn {
            padding: 8px 14px;
            font-size: .78rem;
            font-weight: 700;
            font-family: 'Cairo', 'Inter', sans-serif;
            cursor: pointer;
            border: none;
            background: white;
            color: var(--text-muted);
            transition: background .15s, color .15s;
        }

        .lang-btn.active {
            background: var(--primary);
            color: white;
        }

        .lang-btn:first-child {
            border-left: none;
        }

        .lang-divider {
            width: 1px;
            background: var(--border);
            align-self: stretch;
        }

        /* ── TABS ── */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--card);
            padding: 6px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 28px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 11px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 700;
            font-size: .875rem;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            white-space: nowrap;
            min-width: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background .15s, color .15s;
        }

        .tab:hover:not(.active) {
            background: var(--bg);
            color: var(--text-main);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(79, 70, 229, .35);
        }

        /* ── PANELS ── */
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ── FILTER BAR ── */
        .filter-bar {
            background: var(--card);
            padding: 20px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: .7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .05em;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: 'Cairo', 'Inter', sans-serif;
            font-size: .875rem;
            background: var(--bg);
            color: var(--text-main);
            outline: none;
            transition: border-color .15s, box-shadow .15s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, .12);
        }

        /* ── KPI ── */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 22px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        }

        html[dir="ltr"] .kpi-card::before {
            right: auto;
            left: 0;
            border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
        }

        .kpi-requests::before {
            background: var(--primary);
        }

        .kpi-latency::before {
            background: var(--success);
        }

        .kpi-lang::before {
            background: var(--warning);
        }

        .kpi-countries::before {
            background: var(--info);
        }

        .kpi-icon {
            width: 52px;
            height: 52px;
            border-radius: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .kpi-requests .kpi-icon {
            background: var(--primary-light);
            color: var(--primary);
        }

        .kpi-latency .kpi-icon {
            background: var(--success-light);
            color: var(--success);
        }

        .kpi-lang .kpi-icon {
            background: var(--warning-light);
            color: var(--warning);
        }

        .kpi-countries .kpi-icon {
            background: var(--info-light);
            color: var(--info);
        }

        .kpi-data h3 {
            font-size: .72rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .04em;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1.1;
            margin-top: 4px;
        }

        /* ── CHARTS ── */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 22px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .chart-card h3 {
            font-size: .9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-card h3 i {
            color: var(--primary);
        }

        .chart-wrap {
            height: 230px;
            position: relative;
        }

        /* ── TABLE ── */
        .table-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-head {
            padding: 20px 28px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-head h3 {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-head h3 i {
            color: var(--primary);
        }

        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 13px 24px;
            background: var(--bg);
            color: var(--text-muted);
            font-weight: 700;
            font-size: .7rem;
            text-transform: uppercase;
            letter-spacing: .05em;
            border-bottom: 1px solid var(--border);
        }

        html[dir="rtl"] th {
            text-align: right;
        }

        html[dir="ltr"] th {
            text-align: left;
        }

        td {
            padding: 13px 24px;
            border-bottom: 1px solid var(--border-light);
            font-size: .84rem;
            color: var(--text-main);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--bg);
            cursor: pointer;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 28px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }

        .pagination span {
            font-size: .82rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* ── BADGES ── */
        .badge {
            padding: 3px 9px;
            border-radius: 20px;
            font-size: .67rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .04em;
            display: inline-block;
        }

        .badge-mobile {
            background: #dcfce7;
            color: #166534;
        }

        .badge-desktop {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-voice {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ── DATA MANAGEMENT ── */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .action-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .action-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .action-icon {
            width: 44px;
            height: 44px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .icon-indigo {
            background: var(--primary-light);
            color: var(--primary);
        }

        .icon-green {
            background: var(--success-light);
            color: var(--success);
        }

        .action-card h4 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .action-card>p {
            font-size: .82rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            line-height: 1.65;
        }

        .task-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 11px;
            border-radius: 20px;
            font-size: .72rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .task-status::before {
            content: '';
            width: 7px;
            height: 7px;
            border-radius: 50%;
        }

        .status-idle::before {
            background: #94a3b8;
        }

        .status-idle {
            background: #f1f5f9;
            color: var(--text-muted);
        }

        .status-running::before {
            background: var(--warning);
        }

        .status-running {
            background: var(--warning-light);
            color: var(--warning);
            animation: pulse 1.5s infinite;
        }

        .status-completed::before {
            background: var(--success);
        }

        .status-completed {
            background: var(--success-light);
            color: var(--success);
        }

        .status-failed::before {
            background: var(--danger);
        }

        .status-failed {
            background: var(--danger-light);
            color: var(--danger);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .45
            }
        }

        .last-run {
            font-size: .73rem;
            color: var(--text-muted);
            margin-bottom: 14px;
        }

        .file-drop {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg);
            transition: border-color .15s;
        }

        .file-drop:hover {
            border-color: var(--primary);
        }

        .file-drop input[type="file"] {
            width: 100%;
            font-family: 'Cairo', 'Inter', sans-serif;
            font-size: .82rem;
        }

        .notice-box {
            background: var(--warning-light);
            border: 1px solid #fde68a;
            border-right: 4px solid var(--warning);
            border-radius: var(--radius-md);
            padding: 16px 20px;
        }

        html[dir="ltr"] .notice-box {
            border-right: 1px solid #fde68a;
            border-left: 4px solid var(--warning);
        }

        .notice-box strong {
            color: var(--warning);
            display: block;
            margin-bottom: 8px;
            font-size: .875rem;
        }

        .notice-box ul {
            padding-right: 18px;
        }

        html[dir="ltr"] .notice-box ul {
            padding-right: 0;
            padding-left: 18px;
        }

        .notice-box li {
            font-size: .81rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            line-height: 1.5;
        }

        /* ── MODALS ── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, .65);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            padding: 28px;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 520px;
            box-shadow: var(--shadow-lg);
            animation: slideUp .22s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(14px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .modal h2 {
            font-size: 1.15rem;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal h2 i {
            color: var(--primary);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 11px 0;
            border-bottom: 1px solid var(--border-light);
            gap: 20px;
        }

        .detail-row:last-of-type {
            border-bottom: none;
        }

        .detail-row .key {
            color: var(--text-muted);
            font-weight: 600;
            font-size: .81rem;
            flex-shrink: 0;
        }

        .detail-row .val {
            color: var(--text-main);
            font-weight: 700;
            font-size: .84rem;
            word-break: break-all;
        }

        html[dir="ltr"] .detail-row .val {
            text-align: right;
        }

        .modal-input {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: 'Cairo', 'Inter', sans-serif;
            font-size: .875rem;
            background: var(--bg);
            outline: none;
            transition: border-color .15s, box-shadow .15s;
        }

        .modal-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, .12);
        }

        .field-label {
            font-size: .75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .04em;
            display: block;
            margin-bottom: 6px;
        }

        /* ── SPINNER ── */
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* ✨ NEW: Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* ── RESPONSIVE ── */
        @media(max-width:768px) {
            body {
                padding: 12px;
            }

            header {
                flex-direction: column;
                gap: 14px;
            }

            .btn-group {
                justify-content: center;
            }

            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media(max-width:480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .tab {
                min-width: 100px;
                font-size: .78rem;
                padding: 9px 10px;
            }
        }
    </style>
</head>

<body>

    <!-- ═══ HEADER ═══ -->
    <header>
        <div class="brand">
            <img class="brand-logo" src="./public/logo.png" alt="GOEIC"
                onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
            <div class="brand-icon" style="display:none"><i class="fas fa-landmark"></i></div>
            <div class="brand-text">
                <h1>GOEIC Analytics</h1>
                <small data-ar="لوحة تحكم المساعد الذكي - نظام محلي 100%" data-en="AI Assistant Dashboard - 100% Offline">لوحة تحكم المساعد الذكي - نظام محلي 100%</small>
            </div>
        </div>
        <div class="btn-group">
            <!-- Language Toggle -->
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLang('ar')" id="btn-lang-ar">عربي</button>
                <div class="lang-divider"></div>
                <button class="lang-btn" onclick="setLang('en')" id="btn-lang-en">EN</button>
            </div>
            <button id="headerSyncBtn" class="btn btn-primary" onclick="refreshData(currentPage)">
                <i class="fas fa-sync-alt"></i> <span data-ar="تحديث البيانات" data-en="Sync Data">تحديث البيانات</span>
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <i class="fas fa-file-export"></i> <span data-ar="تصدير CSV" data-en="Export CSV">تصدير CSV</span>
            </button>
            <button class="btn btn-outline" onclick="openUserModal()">
                <i class="fas fa-user-shield"></i> <span data-ar="المديرون" data-en="Admins">المديرون</span>
            </button>
            <button id="logoutBtn" class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> <span data-ar="تسجيل خروج" data-en="Logout">تسجيل خروج</span>
            </button>
        </div>
    </header>

    <!-- ═══ TABS ═══ -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('analytics',this)">
            <i class="fas fa-chart-bar"></i>
            <span data-ar="الإحصائيات" data-en="Analytics">الإحصائيات</span>
        </div>
        <div class="tab" onclick="switchTab('data-management',this)">
            <i class="fas fa-database"></i>
            <span data-ar="إدارة البيانات" data-en="Data Management">إدارة البيانات</span>
        </div>
    </div>

    <!-- ═══ PANEL: ANALYTICS ═══ -->
    <div id="panel-analytics" class="tab-panel active">

        <!-- Filters -->
        <div class="filter-bar">
            <div class="filter-group">
                <label><i class="fas fa-globe-americas"></i> <span data-ar="الدولة"
                        data-en="Country">الدولة</span></label>
                <select id="filter-country">
                    <option value="" data-ar="الكل" data-en="All">الكل</option>
                </select>
            </div>
            <div class="filter-group">
                <label><i class="fas fa-network-wired"></i> <span data-ar="عنوان IP" data-en="IP Address">عنوان
                        IP</span></label>
                <input type="text" id="filter-ip" placeholder="192.168.1.1">
            </div>
            <div class="filter-group">
                <label><i class="fas fa-calendar-alt"></i> <span data-ar="من تاريخ" data-en="From Date">من
                        تاريخ</span></label>
                <input type="date" id="filter-start-date">
            </div>
            <div class="filter-group">
                <label><i class="fas fa-calendar-alt"></i> <span data-ar="إلى تاريخ" data-en="To Date">إلى
                        تاريخ</span></label>
                <input type="date" id="filter-end-date">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <div class="btn-group" style="gap:8px">
                    <button id="applyBtn" class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> <span data-ar="تطبيق" data-en="Apply">تطبيق</span>
                    </button>
                    <button class="btn btn-outline" onclick="resetFilters()">
                        <i class="fas fa-eraser"></i> <span data-ar="مسح" data-en="Clear">مسح</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card kpi-requests">
                <div class="kpi-icon"><i class="fas fa-bolt"></i></div>
                <div class="kpi-data">
                    <h3 data-ar="إجمالي الطلبات" data-en="Total Requests">إجمالي الطلبات</h3>
                    <div class="kpi-value" id="kpiTotal">—</div>
                </div>
            </div>
            <div class="kpi-card kpi-latency">
                <div class="kpi-icon"><i class="fas fa-clock"></i></div>
                <div class="kpi-data">
                    <h3 data-ar="متوسط وقت الاستجابة" data-en="Avg Response Time">متوسط وقت الاستجابة</h3>
                    <div class="kpi-value" id="kpiAvg">—</div>
                </div>
            </div>
            <div class="kpi-card kpi-lang">
                <div class="kpi-icon"><i class="fas fa-language"></i></div>
                <div class="kpi-data">
                    <h3 data-ar="أكثر لغة استخداماً" data-en="Top Language">أكثر لغة استخداماً</h3>
                    <div class="kpi-value" id="kpiTopLang">—</div>
                </div>
            </div>
            <div class="kpi-card kpi-countries">
                <div class="kpi-icon"><i class="fas fa-map-marked-alt"></i></div>
                <div class="kpi-data">
                    <h3 data-ar="عدد الدول" data-en="Countries">عدد الدول</h3>
                    <div class="kpi-value" id="kpiCountries">—</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3><i class="fas fa-laptop"></i> <span data-ar="الأجهزة" data-en="Devices">الأجهزة</span></h3>
                <div class="chart-wrap"><canvas id="devicesChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3><i class="fas fa-map-marker-alt"></i> <span data-ar="أكثر الدول" data-en="Top Countries">أكثر
                        الدول</span></h3>
                <div class="chart-wrap"><canvas id="countriesChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3><i class="fas fa-chart-pie"></i> <span data-ar="اللغات" data-en="Languages">اللغات</span></h3>
                <div class="chart-wrap"><canvas id="languagesChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3><i class="fas fa-crosshairs"></i> <span data-ar="أنواع الاستفسارات"
                        data-en="Query Intent Types">أنواع الاستفسارات</span></h3>
                <div class="chart-wrap"><canvas id="intentsChart"></canvas></div>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="table-card">
            <div class="table-head">
                <h3><i class="fas fa-stream"></i> <span data-ar="سجلات الطلبات المباشرة"
                        data-en="Live Request Logs">سجلات الطلبات المباشرة</span></h3>
                <span style="font-size:.75rem;color:var(--text-muted)">Real-time traffic</span>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr id="logs-thead">
                            <th data-ar="الوقت" data-en="Time">الوقت</th>
                            <th data-ar="الجهاز" data-en="Device">الجهاز</th>
                            <th data-ar="الدولة" data-en="Country">الدولة</th>
                            <th data-ar="عنوان IP" data-en="IP Address">عنوان IP</th>
                            <th data-ar="اللغة" data-en="Language">اللغة</th>
                            <th data-ar="النية" data-en="Intent">النية</th>
                            <th data-ar="الاستعلام" data-en="Query">الاستعلام</th>
                            <th data-ar="وقت الاستجابة" data-en="Response Time">وقت الاستجابة</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body">
                        <tr>
                            <td colspan="8" style="text-align:center;padding:48px;color:var(--text-muted)">
                                <div class="spinner"></div>
                                <span data-ar="جاري تحميل السجلات..." data-en="Loading logs...">جاري تحميل
                                    السجلات...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="btn btn-outline" id="prevBtn" onclick="changePage(-1)" disabled>
                    <i id="prevIcon" class="fas fa-chevron-right"></i>
                    <span data-ar="السابق" data-en="Previous">السابق</span>
                </button>
                <span id="pageInfo">—</span>
                <button class="btn btn-outline" id="nextBtn" onclick="changePage(1)" disabled>
                    <span data-ar="التالي" data-en="Next">التالي</span>
                    <i id="nextIcon" class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ═══ PANEL: DATA MANAGEMENT (UPDATED FOR OFFLINE) ═══ -->
    <div id="panel-data-management" class="tab-panel">
        <div class="data-grid">
            <!-- ✨ SMART WEB SCRAPING CARD -->
            <div class="action-card">
                <div class="action-header">
                    <div class="action-icon icon-indigo"><i class="fas fa-spider"></i></div>
                    <h4 data-ar="تحديث بيانات الموقع (ذكي)" data-en="Smart Website Update">تحديث بيانات الموقع (ذكي)</h4>
                </div>
                <p data-ar="استخراج أحدث البيانات من موقع GOEIC بدون تكرار. يتم فهرستها محلياً بدون تكلفة API!"
                    data-en="Extract latest GOEIC data without duplicates. Indexed locally with no API cost!">
                    استخراج أحدث البيانات من موقع GOEIC بدون تكرار. يتم فهرستها محلياً بدون تكلفة API!</p>
                
                <div id="scraping-status" class="task-status status-idle" data-status-key="idle">
                    <span data-ar="جاهز" data-en="Ready">جاهز</span>
                </div>
                
                <div class="progress-bar" id="scraping-progress" style="display:none">
                    <div class="progress-fill" id="scraping-progress-fill"></div>
                </div>
                
                <div id="scraping-message" class="last-run">
                    <span data-ar="لم يتم التشغيل بعد" data-en="Not run yet">لم يتم التشغيل بعد</span>
                </div>
                
                <button id="btn-scrape" class="btn btn-primary" style="width:100%;justify-content:center"
                    onclick="triggerScraping()">
                    <i class="fas fa-play"></i> 
                    <span data-ar="بدء الاستخراج الذكي" data-en="Start Smart Scraping">بدء الاستخراج الذكي</span>
                </button>
            </div>

            <!-- ✨ SMART EXCEL UPLOAD CARD -->
            <div class="action-card">
                <div class="action-header">
                    <div class="action-icon icon-green"><i class="fas fa-file-excel"></i></div>
                    <h4 data-ar="رفع ملف Excel (ذكي)" data-en="Smart Excel Upload">رفع ملف Excel (ذكي)</h4>
                </div>
                <p data-ar="رفع Excel مع ملفات PDF/Word. يتم كشف التكرار تلقائياً ويُفهرس محلياً بدون API!"
                    data-en="Upload Excel with PDF/Word files. Auto-detects duplicates & indexes locally - no API cost!">
                    رفع Excel مع ملفات PDF/Word. يتم كشف التكرار تلقائياً ويُفهرس محلياً بدون API!</p>
                
                <div id="upload-status" class="task-status status-idle" data-status-key="idle">
                    <span data-ar="جاهز" data-en="Ready">جاهز</span>
                </div>
                
                <div class="progress-bar" id="upload-progress" style="display:none">
                    <div class="progress-fill" id="upload-progress-fill"></div>
                </div>
                
                <div id="upload-message" class="last-run">
                    <span data-ar="لم يتم الرفع بعد" data-en="Not uploaded yet">لم يتم الرفع بعد</span>
                </div>
                
                <div class="file-drop">
                    <input type="file" id="excel-file" accept=".xlsx,.xls">
                </div>
                
                <button id="btn-upload-excel" class="btn btn-success" style="width:100%;justify-content:center"
                    onclick="uploadExcel()">
                    <i class="fas fa-upload"></i> 
                    <span data-ar="رفع وفهرسة محلياً" data-en="Upload & Index Locally">رفع وفهرسة محلياً</span>
                </button>
            </div>
        </div>

        <!-- ✨ REAL-TIME LOG VIEWER -->
        <div class="action-card" style="grid-column: 1 / -1;">
            <div class="action-header">
                <div class="action-icon icon-indigo"><i class="fas fa-terminal"></i></div>
                <h4 data-ar="سجلات النظام المباشرة" data-en="Live System Logs">سجلات النظام المباشرة</h4>
            </div>
            <p data-ar="شاهد سجلات العمليات لحظياً أثناء التنفيذ"
                data-en="Watch operation logs in real-time during execution">
                شاهد سجلات العمليات لحظياً أثناء التنفيذ</p>
            
            <div style="background: #0a0e14; border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.75rem; color: #00ff00; border: 1px solid var(--border);" id="log-viewer">
                <div style="color: #8b949e; font-style: italic;">
                    <span data-ar="جاري الاتصال بخادم السجلات..." data-en="Connecting to log server...">جاري الاتصال بخادم السجلات...</span>
                </div>
            </div>
            
            <div style="margin-top: 10px; display: flex; gap: 2px;">
                <button class="btn btn-outline" style="flex: 1;" onclick="clearLogs()">
                    <i class="fas fa-eraser"></i>
                    <span data-ar="مسح السجلات" data-en="Clear Logs">مسح السجلات</span>
                </button>
                <button class="btn btn-primary" style="flex: 1;" onclick="downloadLogs()">
                    <i class="fas fa-download"></i>
                    <span data-ar="تنزيل السجلات" data-en="Download Logs">تنزيل السجلات</span>
                </button>
            </div>
        </div>

        <!-- Enhanced Notice Box
        <div class="notice-box" style="grid-column: 1 / -1;">
            <strong><i class="fas fa-info-circle"></i>
                <span data-ar="النظام الجديد - 100% محلي" data-en="New System - 100% Offline">النظام الجديد - 100% محلي</span>
            </strong>
            <ul>
                <li data-ar="✅ جميع العمليات تعمل محلياً (Ollama + Local Embeddings)"
                    data-en="✅ All operations run locally (Ollama + Local Embeddings)">
                    ✅ جميع العمليات تعمل محلياً (Ollama + Local Embeddings)</li>
                <li data-ar="✅ كشف تلقائي للتكرار (لن يتم إضافة نفس البيانات مرتين)"
                    data-en="✅ Auto duplicate detection (no data added twice)">
                    ✅ كشف تلقائي للتكرار (لن يتم إضافة نفس البيانات مرتين)</li>
                <li data-ar="✅ تكلفة API: 0 دولار شهرياً (توفير $2,000-4,000)"
                    data-en="✅ API cost: $0/month (saving $2,000-4,000)">
                    ✅ تكلفة API: 0 دولار شهرياً (توفير $2,000-4,000)</li>
                <li data-ar="✅ جودة الإجابات: 90-95% من GPT-4 Pro"
                    data-en="✅ Response quality: 90-95% of GPT-4 Pro">
                    ✅ جودة الإجابات: 90-95% من GPT-4 Pro</li>
                <li data-ar="⚡ قد تستغرق العمليات وقتاً حسب حجم البيانات"
                    data-en="⚡ Operations may take time depending on data size">
                    ⚡ قد تستغرق العمليات وقتاً حسب حجم البيانات</li>
            </ul>
        </div> -->
    </div>

    <!-- ═══ MODAL: DETAIL ═══ -->
    <div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeDetailModal()">
        <div class="modal">
            <h2><i class="fas fa-info-circle"></i>
                <span data-ar="تفاصيل الطلب" data-en="Request Details">تفاصيل الطلب</span>
            </h2>
            <div id="detailContent"></div>
            <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:20px"
                onclick="closeDetailModal()">
                <span data-ar="إغلاق" data-en="Close">إغلاق</span>
            </button>
        </div>
    </div>

    <!-- ═══ MODAL: USER MANAGEMENT ═══ -->
    <div id="userModal" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal">
            <h2><i class="fas fa-users-cog"></i>
                <span data-ar="إدارة المديرين" data-en="Admin Management">إدارة المديرين</span>
            </h2>
            <div style="margin-bottom:14px">
                <label class="field-label" data-ar="اسم المستخدم" data-en="Username">اسم المستخدم</label>
                <input type="text" id="new_username" class="modal-input" data-placeholder-ar="أدخل اسم المستخدم"
                    data-placeholder-en="Enter username" placeholder="أدخل اسم المستخدم">
            </div>
            <div style="margin-bottom:20px">
                <label class="field-label" data-ar="كلمة المرور" data-en="Password">كلمة المرور</label>
                <input type="password" id="new_password" class="modal-input" placeholder="••••••••">
            </div>
            <div class="btn-group" style="margin-bottom:10px">
                <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="manageUser('add')">
                    <i class="fas fa-user-plus"></i>
                    <span data-ar="إنشاء مدير" data-en="Create Admin">إنشاء مدير</span>
                </button>
                <button class="btn btn-warning" style="flex:1;justify-content:center"
                    onclick="manageUser('change-password')">
                    <i class="fas fa-key"></i>
                    <span data-ar="تغيير كلمة المرور" data-en="Change Password">تغيير كلمة المرور</span>
                </button>
            </div>
            <button class="btn btn-outline" style="width:100%;justify-content:center"
                onclick="document.getElementById('userModal').style.display='none'">
                <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
            </button>
        </div>
    </div>

    <script>
        // ───────────────────────────────────────
        // STATE
        // ───────────────────────────────────────
        let currentPage = 1;
        let totalPages = 1;
        let statusInterval = null;
        let currentLang = 'ar';

        const PALETTE = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#14b8a6'];

        // ───────────────────────────────────────
        // LANGUAGE SYSTEM
        // ───────────────────────────────────────
        function setLang(lang) {
            currentLang = lang;
            const html = document.documentElement;

            html.setAttribute('lang', lang);
            html.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');

            document.getElementById('btn-lang-ar').classList.toggle('active', lang === 'ar');
            document.getElementById('btn-lang-en').classList.toggle('active', lang === 'en');

            document.getElementById('prevIcon').className = lang === 'ar' ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
            document.getElementById('nextIcon').className = lang === 'ar' ? 'fas fa-chevron-left' : 'fas fa-chevron-right';

            document.querySelectorAll('[data-ar][data-en]').forEach(el => {
                if (el.children.length === 0) {
                    el.textContent = el.getAttribute(`data-${lang}`);
                }
            });

            document.querySelectorAll('h3[data-ar], h4[data-ar], p[data-ar], span[data-ar]').forEach(el => {
                const text = el.getAttribute(`data-${lang}`);
                if (text) el.textContent = text;
            });

            document.querySelectorAll('th[data-ar]').forEach(th => {
                th.textContent = th.getAttribute(`data-${lang}`);
            });

            document.querySelectorAll('[data-placeholder-ar]').forEach(el => {
                el.placeholder = el.getAttribute(`data-placeholder-${lang}`);
            });

            updatePageInfo();

            document.querySelectorAll('#filter-country option[value=""]').forEach(o => {
                o.textContent = lang === 'ar' ? 'الكل' : 'All';
            });
        }

        const STATUS_LABELS = {
            ar: { idle: 'جاهز', running: 'قيد التنفيذ...', completed: 'اكتمل بنجاح', failed: 'فشلت العملية' },
            en: { idle: 'Ready', running: 'Running...', completed: 'Completed', failed: 'Failed' }
        };

        function t(ar, en) { return currentLang === 'ar' ? ar : en; }

        function updatePageInfo() {
            document.getElementById('pageInfo').textContent =
                currentLang === 'ar'
                    ? `الصفحة ${currentPage} من ${totalPages}`
                    : `Page ${currentPage} of ${totalPages}`;
        }

        // ───────────────────────────────────────
        // TAB SWITCHING
        // ───────────────────────────────────────
        function switchTab(name, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('panel-' + name).classList.add('active');
            if (name === 'analytics') refreshData(currentPage);
            if (name === 'data-management') { checkTaskStatus(); startStatusPolling(); }
        }

        // ───────────────────────────────────────
        // FILTERS
        // ───────────────────────────────────────
        function applyFilters() { currentPage = 1; refreshData(1); }
        function resetFilters() {
            ['filter-country', 'filter-ip', 'filter-start-date', 'filter-end-date']
                .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            currentPage = 1; refreshData(1);
        }

        // ───────────────────────────────────────
        // MAIN FETCH
        // ───────────────────────────────────────
        async function refreshData(page = 1) {
            currentPage = page;
            const syncBtn = document.getElementById('headerSyncBtn');
            const applyBtn = document.getElementById('applyBtn');
            if (syncBtn) { syncBtn.disabled = true; syncBtn.querySelector('span').textContent = t('جاري التحميل...', 'Loading...'); }
            if (applyBtn) { applyBtn.disabled = true; }

            const params = new URLSearchParams({
                page, page_size: 20,
                country: document.getElementById('filter-country').value,
                ip_address: document.getElementById('filter-ip').value,
                start_date: document.getElementById('filter-start-date').value,
                end_date: document.getElementById('filter-end-date').value
            });

            try {
                const res = await fetch(`/api/stats?${params}`);
                if (res.status === 401) { window.location.replace('/admin'); return; }
                if (!res.ok) throw new Error('HTTP ' + res.status);
                renderDashboard(await res.json());
            } catch (err) {
                console.error('Stats error:', err);
            } finally {
                if (syncBtn) { syncBtn.disabled = false; syncBtn.querySelector('span').textContent = t('تحديث البيانات', 'Sync Data'); }
                if (applyBtn) { applyBtn.disabled = false; }
            }
        }

        // ───────────────────────────────────────
        // RENDER DASHBOARD
        // ───────────────────────────────────────
        function renderDashboard(data) {
            if (!data) return;

            document.getElementById('kpiTotal').textContent = (data.total_records || 0).toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('kpiAvg').textContent = (data.avg_time || 0).toFixed(2) + 's';
            document.getElementById('kpiCountries').textContent = (data.countries_list || []).length;
            const topL = (data.languages || []).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('kpiTopLang').textContent = topL ? topL[0].toUpperCase() : '—';

            populateSelect('filter-country', data.countries_list || [], c => [c[0], c[0]]);

            drawChart('devicesChart', 'pie', data.devices || [], true);
            drawChart('countriesChart', 'bar', data.countries_chart || [], false, t('الطلبات', 'Requests'));
            drawChart('languagesChart', 'doughnut', data.languages || [], true);
            drawChart('intentsChart', 'bar', data.intents || [], false, t('الاستفسارات', 'Queries'), true);

            renderLogs(data.recent_logs || []);

            totalPages = data.total_pages || 1;
            currentPage = data.current_page || 1;
            updatePageInfo();
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function populateSelect(id, list, mapper) {
            const sel = document.getElementById(id);
            const cur = sel.value;
            sel.innerHTML = `<option value="">${t('الكل', 'All')}</option>`;
            list.forEach(item => { const [val, label] = mapper(item); sel.add(new Option(label, val)); });
            sel.value = cur;
        }

        // ───────────────────────────────────────
        // CHARTS
        // ───────────────────────────────────────
        function drawChart(id, type, raw, useMultiColor, label = '', horizontal = false) {
            const existing = Chart.getChart(id);
            if (existing) existing.destroy();
            const ctx = document.getElementById(id);
            if (!ctx) return;
            const isBar = type === 'bar';
            new Chart(ctx.getContext('2d'), {
                type,
                data: {
                    labels: raw.map(d => d[0]),
                    datasets: [{
                        label,
                        data: raw.map(d => d[1]),
                        backgroundColor: useMultiColor
                            ? raw.map((_, i) => PALETTE[i % PALETTE.length])
                            : PALETTE[horizontal ? 1 : 0],
                        borderRadius: isBar ? 6 : 0,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    indexAxis: horizontal ? 'y' : 'x',
                    plugins: {
                        legend: {
                            display: !isBar, position: 'bottom',
                            labels: { usePointStyle: true, padding: 14, font: { size: 11, family: "'Cairo','Inter',sans-serif", weight: '600' } }
                        }
                    },
                    scales: isBar ? {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { family: "'Cairo','Inter',sans-serif" } } },
                        x: { grid: { display: false }, ticks: { font: { family: "'Cairo','Inter',sans-serif" } } }
                    } : {}
                }
            });
        }

        // ───────────────────────────────────────
        // LOGS TABLE
        // ───────────────────────────────────────
        function renderLogs(logs) {
            const tbody = document.getElementById('logs-table-body');
            if (!logs.length) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">${t('لا توجد سجلات', 'No logs found')}</td></tr>`;
                return;
            }
            tbody.innerHTML = logs.map(log => {
                const dt = (log.device_type || '').toLowerCase();
                const bc = dt.includes('mobile') || dt.includes('android') || dt.includes('iphone')
                    ? 'badge-mobile' : dt.includes('voice') ? 'badge-voice' : 'badge-desktop';
                const ts = new Date(log.timestamp).toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US', { hour12: false });
                const q = (log.query || '').slice(0, 65) + ((log.query || '').length > 65 ? '…' : '');
                return `<tr onclick="showDetail(this)" data-json="${encodeURIComponent(JSON.stringify(log))}">
                <td style="font-weight:600;white-space:nowrap;font-size:.77rem">${ts}</td>
                <td><span class="badge ${bc}">${log.device_type || '—'}</span></td>
                <td>${log.country || '—'}</td>
                <td style="direction:ltr;text-align:left;font-family:monospace;font-size:.77rem">${log.ip_address || '—'}</td>
                <td><span style="background:var(--bg);padding:2px 8px;border-radius:5px;font-size:.74rem">${log.language || '—'}</span></td>
                <td><span style="background:#ede9fe;color:#6d28d9;padding:2px 8px;border-radius:5px;font-size:.74rem">${log.intent || '—'}</span></td>
                <td style="max-width:220px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:var(--text-muted)">${q}</td>
                <td style="color:var(--success);font-weight:700">${(log.response_time || 0).toFixed(2)}s</td>
            </tr>`;
            }).join('');
        }

        // ───────────────────────────────────────
        // PAGINATION
        // ───────────────────────────────────────
        function changePage(step) {
            const target = currentPage + step;
            if (target >= 1 && target <= totalPages) refreshData(target);
        }

        // ───────────────────────────────────────
        // DETAIL MODAL
        // ───────────────────────────────────────
        function showDetail(row) {
            try {
                const log = JSON.parse(decodeURIComponent(row.dataset.json));
                const field = (key_ar, key_en, val, style = '') =>
                    `<div class="detail-row">
                    <span class="key">${t(key_ar, key_en)}</span>
                    <span class="val" ${style}>${val}</span>
                </div>`;
                document.getElementById('detailContent').innerHTML =
                    field('معرف الطلب', 'Request ID', log.request_id || '—') +
                    field('الوقت', 'Timestamp', new Date(log.timestamp).toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US')) +
                    field('عنوان IP', 'IP Address', log.ip_address || '—', 'style="direction:ltr"') +
                    field('الدولة', 'Country', log.country || '—') +
                    field('الجهاز', 'Device', log.device_type || '—') +
                    field('اللغة', 'Language', log.language || '—') +
                    field('النية', 'Intent', log.intent || '—') +
                    field('الاستعلام', 'Query', log.query || '—') +
                    field('وقت الاستجابة', 'Response Time', `<span style="color:var(--success)">${(log.response_time || 0).toFixed(3)}s</span>`);
                document.getElementById('detailModal').style.display = 'flex';
            } catch (e) { console.error(e); }
        }
        function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }

        // ───────────────────────────────────────
        // USER MANAGEMENT
        // ───────────────────────────────────────
        function openUserModal() { document.getElementById('userModal').style.display = 'flex'; }

        async function manageUser(action) {
            const username = document.getElementById('new_username').value.trim();
            const password = document.getElementById('new_password').value.trim();
            if (!username || !password) {
                alert(t('يرجى ملء جميع الحقول', 'Please fill all fields'));
                return;
            }
            try {
                const res = await fetch(`/api/users/${action}`, {
                    method: action === 'add' ? 'POST' : 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (res.ok) {
                    alert(t('تمت العملية بنجاح', 'Operation completed successfully'));
                    document.getElementById('userModal').style.display = 'none';
                    document.getElementById('new_username').value = '';
                    document.getElementById('new_password').value = '';
                } else {
                    const err = await res.json();
                    alert(t('فشلت العملية: ', 'Operation failed: ') + (err.detail || ''));
                }
            } catch (e) { alert(t('خطأ في الاتصال: ', 'Connection error: ') + e.message); }
        }

        // ───────────────────────────────────────
        // EXPORT
        // ───────────────────────────────────────
        function exportData() {
            const params = new URLSearchParams({
                country: document.getElementById('filter-country').value,
                ip_address: document.getElementById('filter-ip').value,
                start_date: document.getElementById('filter-start-date').value,
                end_date: document.getElementById('filter-end-date').value
            });
            window.location.href = `/api/export?${params}`;
        }

        // ───────────────────────────────────────
        // LOGOUT
        // ───────────────────────────────────────
        async function logout() {
            const btn = document.getElementById('logoutBtn');
            btn.disabled = true;
            btn.querySelector('span').textContent = t('جاري الخروج...', 'Logging out...');
            try { await fetch('/api/logout', { method: 'POST' }); } catch (e) { }
            window.location.replace('/admin?ts=' + Date.now());
        }

        // ───────────────────────────────────────
        // ✨ DATA MANAGEMENT - OFFLINE SYSTEM
        // ───────────────────────────────────────
        async function triggerScraping() {
            const btn = document.getElementById('btn-scrape');
            if (btn.disabled) return;
            
            if (!confirm(t(
                'هل أنت متأكد من بدء الاستخراج الذكي؟ سيتم فهرسة البيانات الجديدة فقط (بدون تكرار).',
                'Start smart scraping? Only new data will be indexed (no duplicates).'
            ))) return;
            
            btn.disabled = true;
            btn.querySelector('span').textContent = t('جاري البدء...', 'Starting...');
            
            try {
                const res = await fetch('/api/admin/scrape-website', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'running') {
                    setTaskStatus('scraping', 'running', data.message);
                    startStatusPolling();
                } else {
                    alert(data.message || t('حدث خطأ', 'An error occurred'));
                    resetButton('scraping');
                }
            } catch (e) {
                alert(t('خطأ في الاتصال', 'Connection error') + ': ' + e.message);
                resetButton('scraping');
            }
        }

        async function uploadExcel() {
            const fileInput = document.getElementById('excel-file');
            const btn = document.getElementById('btn-upload-excel');
            
            if (!fileInput.files || !fileInput.files.length) {
                alert(t('يرجى اختيار ملف Excel أولاً', 'Please select an Excel file first'));
                return;
            }
            
            if (!confirm(t(
                `رفع "${fileInput.files[0].name}"؟ سيتم كشف التكرار تلقائياً.`,
                `Upload "${fileInput.files[0].name}"? Duplicates will be auto-detected.`
            ))) return;
            
            btn.disabled = true;
            btn.querySelector('span').textContent = t('جاري الرفع...', 'Uploading...');
            
            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            formData.append('base_dir', '.');
            
            try {
                const res = await fetch('/api/admin/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.status === 'running') {
                    setTaskStatus('upload', 'running', data.message);
                    startStatusPolling();
                } else {
                    alert(data.message || t('حدث خطأ', 'An error occurred'));
                    resetButton('upload');
                }
            } catch (e) {
                alert(t('خطأ في الرفع', 'Upload error') + ': ' + e.message);
                resetButton('upload');
            }
        }

        async function checkTaskStatus() {
            try {
                const [scrapingRes, uploadRes] = await Promise.all([
                    fetch('/api/admin/scraping-status'),
                    fetch('/api/admin/upload-status')
                ]);
                
                if (scrapingRes.ok) {
                    const scrapingData = await scrapingRes.json();
                    updateTaskUI('scraping', scrapingData);
                }
                
                if (uploadRes.ok) {
                    const uploadData = await uploadRes.json();
                    updateTaskUI('upload', uploadData);
                }
            } catch (e) {
                console.error('Status check error:', e);
            }
        }

        function updateTaskUI(type, data) {
            const isRunning = data.running === true;
            const progress = data.progress || 0;
            const message = data.message || '';
            
            if (isRunning) {
                setTaskStatus(type, 'running', message, progress);
            } else {
                const status = message.includes('completed') || message.includes('اكتمل') 
                    ? 'completed' 
                    : message.includes('fail') || message.includes('فشل')
                    ? 'failed'
                    : 'idle';
                
                setTaskStatus(type, status, message);
                resetButton(type);
                
                // Stop polling if both tasks are done
                setTimeout(() => {
                    if (!document.querySelector('.status-running')) {
                        stopStatusPolling();
                    }
                }, 1000);
            }
        }

        function setTaskStatus(type, status, message = '', progress = 0) {
            const badge = document.getElementById(type === 'scraping' ? 'scraping-status' : 'upload-status');
            const msgEl = document.getElementById(type === 'scraping' ? 'scraping-message' : 'upload-message');
            const progressBar = document.getElementById(type === 'scraping' ? 'scraping-progress' : 'upload-progress');
            const progressFill = document.getElementById(type === 'scraping' ? 'scraping-progress-fill' : 'upload-progress-fill');
            
            if (badge) {
                badge.className = `task-status status-${status}`;
                badge.dataset.statusKey = status;
                const statusText = STATUS_LABELS[currentLang][status] || status;
                badge.querySelector('span').textContent = statusText;
            }
            
            if (msgEl) {
                msgEl.querySelector('span').textContent = message || STATUS_LABELS[currentLang][status];
            }
            
            if (progressBar && progressFill) {
                if (status === 'running' && progress > 0) {
                    progressBar.style.display = 'block';
                    progressFill.style.width = progress + '%';
                } else {
                    progressBar.style.display = 'none';
                }
            }
        }

        function resetButton(type) {
            if (type === 'scraping') {
                const btn = document.getElementById('btn-scrape');
                btn.disabled = false;
                btn.querySelector('span').textContent = t('بدء الاستخراج الذكي', 'Start Smart Scraping');
            } else {
                const btn = document.getElementById('btn-upload-excel');
                btn.disabled = false;
                btn.querySelector('span').textContent = t('رفع وفهرسة محلياً', 'Upload & Index Locally');
            }
        }

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(checkTaskStatus, 3000); // Poll every 3 seconds
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // ───────────────────────────────────────
        // ✨ WEBSOCKET: REAL-TIME LOG STREAMING
        // ───────────────────────────────────────
        let logWebSocket = null;
        let logBuffer = [];
        const MAX_LOG_LINES = 500;

        function connectLogStream() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/logs`;
            
            logWebSocket = new WebSocket(wsUrl);
            
            logWebSocket.onopen = () => {
                console.log('✅ Log stream connected');
                appendLog('✅ متصل بخادم السجلات | Connected to log server', 'success');
                
                // Send heartbeat every 25 seconds
                setInterval(() => {
                    if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
                        logWebSocket.send('ping');
                    }
                }, 25000);
            };
            
            logWebSocket.onmessage = (event) => {
                const logLine = event.data;
                
                // Skip heartbeat messages
                if (logLine.includes('heartbeat') || logLine === 'pong') return;
                
                // Parse log level for styling
                let logClass = 'log-info';
                if (logLine.includes('ERROR') || logLine.includes('❌')) {
                    logClass = 'log-error';
                } else if (logLine.includes('WARNING') || logLine.includes('⚠️')) {
                    logClass = 'log-warning';
                } else if (logLine.includes('✅') || logLine.includes('Completed')) {
                    logClass = 'log-success';
                }
                
                appendLog(logLine, logClass);
            };
            
            logWebSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                appendLog('❌ خطأ في الاتصال | Connection error', 'log-error');
            };
            
            logWebSocket.onclose = () => {
                console.log('WebSocket closed, reconnecting in 5s...');
                appendLog('🔌 انقطع الاتصال، إعادة المحاولة... | Disconnected, reconnecting...', 'log-warning');
                setTimeout(connectLogStream, 5000);
            };
        }

        function appendLog(text, className = 'log-info') {
            const logViewer = document.getElementById('log-viewer');
            if (!logViewer) return;
            
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const logEntry = document.createElement('div');
            logEntry.className = `log-line ${className}`;
            logEntry.textContent = `[${timestamp}] ${text}`;
            logEntry.style.marginBottom = '4px';
            
            logViewer.appendChild(logEntry);
            logBuffer.push(logEntry);
            
            // Keep only last MAX_LOG_LINES
            if (logBuffer.length > MAX_LOG_LINES) {
                const removed = logBuffer.shift();
                removed.remove();
            }
            
            // Auto-scroll to bottom
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        function clearLogs() {
            const logViewer = document.getElementById('log-viewer');
            if (logViewer) {
                logViewer.innerHTML = '<div style="color: #8b949e; font-style: italic;">تم مسح السجلات | Logs cleared</div>';
                logBuffer = [];
            }
        }

        function downloadLogs() {
            const logs = logBuffer.map(el => el.textContent).join('\n');
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `goeic_logs_${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Add log styling
        const logStyles = document.createElement('style');
        logStyles.textContent = `
            .log-line { font-family: 'Courier New', monospace; font-size: 0.75rem; }
            .log-info { color: #00ff00; }
            .log-success { color: #00ff00; font-weight: bold; }
            .log-warning { color: #ffa500; }
            .log-error { color: #ff4444; font-weight: bold; }
        `;
        document.head.appendChild(logStyles);

        // ───────────────────────────────────────
        // INIT
        // ───────────────────────────────────────
        window.addEventListener('load', () => {
            refreshData(1);
            setLang('ar');
            // Connect log stream when Data Management tab is active
            const dataTab = document.querySelector('[onclick*="data-management"]');
            if (dataTab) {
                dataTab.addEventListener('click', () => {
                    setTimeout(connectLogStream, 500);
                });
            }
        });
        window.addEventListener('beforeunload', stopStatusPolling);
    </script>
</body>

</html>