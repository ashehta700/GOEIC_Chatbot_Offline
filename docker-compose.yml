# ═══════════════════════════════════════════════════════════════
# GOEIC Enterprise Assistant — Full Stack
#
# Services:
#   1. ollama   — local LLM server (GPU-aware)
#   2. weaviate — vector database with persistent volume
#   3. app      — FastAPI application (CPU, reads .env)
#
# Quick start:
#   docker compose up -d
#
# Pull the model once after first start:
#   docker exec -it goeic-ollama ollama pull qwen2.5:14b
#
# GPU (NVIDIA) — works out of the box if nvidia-container-toolkit
# is installed. Comment out the `deploy:` block to run on CPU only.
# ═══════════════════════════════════════════════════════════════

version: "3.9"

services:

  # ─────────────────────────────────────────────────────────────
  # 1. OLLAMA — Local LLM Server
  #    GPU: requires nvidia-container-toolkit on the host
  #    CPU: remove / comment the deploy: section below
  # ─────────────────────────────────────────────────────────────
  ollama:
    image: ollama/ollama:latest
    container_name: goeic-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama        # persists downloaded models
    environment:
      - OLLAMA_KEEP_ALIVE=24h
      - OLLAMA_NUM_PARALLEL=1
    # ── GPU support (comment out if no GPU) ──────────────────
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all                 # use "1" to limit to one GPU
              capabilities: [gpu]
    # ─────────────────────────────────────────────────────────
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - goeic_net

  # ─────────────────────────────────────────────────────────────
  # 2. WEAVIATE — Vector Database
  # ─────────────────────────────────────────────────────────────
  weaviate:
    image: semitechnologies/weaviate:1.27.2
    container_name: goeic-weaviate
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50051:50051"
    volumes:
      - "D:\\my main laptop\\out projects\\Abdelwahab Project\\app\\app\\GOEIC_Chatbot_V2\\weaviate_data:/var/lib/weaviate"
    environment:
      QUERY_DEFAULTS_LIMIT: "25"
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: "none"
      ENABLE_MODULES: ""
      CLUSTER_HOSTNAME: "node1"
      ASYNC_INDEXING: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/.well-known/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - goeic_net

  # ─────────────────────────────────────────────────────────────
  # 3. APP — GOEIC FastAPI Application
  # ─────────────────────────────────────────────────────────────
  app:
    image: ghcr.io/${GITHUB_REPOSITORY:-your-org/goeic}/goeic-offline:latest
    # Or build locally:
    # build:
    #   context: .
    #   dockerfile: Dockerfile.offline
    container_name: goeic-app
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - app_logs:/app/logs              # persist logs across restarts
      - app_uploads:/app/uploads        # persist uploaded Excel files
      - ./public:/app/public:ro         # serve static files (read-only)
    env_file:
      - .env                            # load secrets from .env file
    environment:
      # These override .env defaults; .env takes precedence for secrets
      OLLAMA_HOST: "http://ollama:11434"
      WEAVIATE_HOST: "weaviate"
    depends_on:
      ollama:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s
    networks:
      - goeic_net

# ─────────────────────────────────────────────────────────────
# VOLUMES  (named — data survives container restarts/upgrades)
# ─────────────────────────────────────────────────────────────
volumes:
  ollama_data:
    driver: local
  weaviate_data:
    driver: local
  app_logs:
    driver: local
  app_uploads:
    driver: local

# ─────────────────────────────────────────────────────────────
# NETWORK
# ─────────────────────────────────────────────────────────────
networks:
  goeic_net:
    driver: bridge